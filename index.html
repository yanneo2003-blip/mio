<!DOCTYPE html>
<html lang="zh-CN" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµå–µ | Mio</title>
    
    <!-- æ ¸å¿ƒä¾èµ– -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/iztro@2.0.5/dist/iztro.min.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        window.onerror = function(msg) { console.error("Runtime:", msg); return false; };
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '-apple-system', 'BlinkMacSystemFont', '"PingFang SC"', '"Microsoft YaHei"', 'sans-serif'],
                        mono: ['"SF Mono"', 'monospace']
                    },
                    colors: {
                        sys: {
                            base: 'var(--bg-base)',
                            surface: 'var(--bg-surface)',
                            surface2: 'var(--bg-surface-2)',
                            main: 'var(--text-main)',
                            muted: 'var(--text-muted)',
                            border: 'var(--border-color)',
                            primary: 'var(--color-primary)',
                            accent: 'var(--color-accent)',
                            highlight: 'var(--color-highlight)',
                        }
                    },
                    boxShadow: { 
                        'glass': '0 8px 30px rgba(0, 0, 0, 0.04)',
                        'float': '0 20px 40px -10px rgba(0, 0, 0, 0.1)',
                    },
                    animation: {
                        'spin-slow': 'spin 8s linear infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            /* Light Mode - iOS Inspired */
            --bg-base: #F2F2F7;
            --bg-surface: #FFFFFF;
            --bg-surface-2: #E5E5EA;
            --text-main: #000000;
            --text-body: #1C1C1E;
            --text-muted: #8E8E93;
            --border-color: #D1D1D6;
            --color-primary: #000000;
            --color-accent: #FF2D55;
            --color-highlight: #FF2D55;
            --scrollbar-thumb: rgba(0, 0, 0, 0.2);
            --glow-color: rgba(0,0,0,0.05);
        }

        html.dark {
            /* Dark Mode - iOS Inspired */
            --bg-base: #000000;
            --bg-surface: #1C1C1E;
            --bg-surface-2: #2C2C2E;
            --text-main: #FFFFFF;
            --text-body: #E5E5EA;
            --text-muted: #8E8E93;
            --border-color: #38383A;
            --color-primary: #FFFFFF;
            --color-accent: #FF375F;
            --color-highlight: #FF375F;
            --scrollbar-thumb: rgba(255, 255, 255, 0.2);
            --glow-color: rgba(255,255,255,0.05);
        }

        body { 
            background-color: var(--bg-base); 
            color: var(--text-body); 
            font-family: "Inter", -apple-system, "PingFang SC", sans-serif;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; margin-block: 30px; }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease, transform 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: translateY(5px); }
        
        .typing-dot { width: 5px; height: 5px; background-color: var(--text-muted); border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Typography */
        strong, b, .prose strong, .prose b { color: var(--text-main) !important; font-weight: 600 !important; font-family: inherit !important; }
        .highlight-marker { color: var(--color-highlight) !important; font-weight: 600; margin: 0 1px; font-family: inherit !important; }
        .action-text { color: var(--text-muted); font-size: 0.85em; font-style: normal !important; margin-left: 2px; }

        .prose blockquote { border-left: 3px solid var(--color-accent); background: var(--bg-surface-2); padding: 0.6rem 1rem; margin: 0.8rem 0; border-radius: 0 8px 8px 0; font-size: 0.9rem; color: var(--text-muted); font-style: normal; }
        html.dark img, html.dark video { filter: brightness(0.85); }

        .quantum-spinner {
            width: 48px; height: 48px; border-radius: 50%;
            background: conic-gradient(from 0deg, transparent 0%, var(--text-muted) 100%);
            -webkit-mask: radial-gradient(farthest-side, transparent calc(100% - 4px), #fff calc(100% - 4px));
            mask: radial-gradient(farthest-side, transparent calc(100% - 4px), #fff calc(100% - 4px));
            animation: spin 1s linear infinite;
        }
        .dark .quantum-spinner { background: conic-gradient(from 0deg, transparent 0%, var(--text-main) 100%); }
        
        /* Parameters Bar */
        .param-badge {
            display: inline-flex; align-items: center; gap: 0.375rem; background-color: var(--bg-surface-2);
            color: var(--text-muted); font-size: 0.65rem; font-weight: 500; padding: 0.25rem 0.6rem;
            border-radius: 0.5rem; border: 1px solid var(--border-color); white-space: nowrap;
        }
        .param-badge.active { color: var(--text-main); border-color: var(--text-muted); }
    </style>
</head>

<body class="h-screen w-screen overflow-hidden flex flex-col items-center justify-center text-sys-body selection:bg-sys-accent selection:text-white">

    <div id="app" class="w-full h-full md:max-w-4xl md:h-[90vh] md:rounded-[20px] flex flex-col relative bg-sys-base shadow-2xl md:border md:border-sys-border overflow-hidden transition-all duration-300">

        <!-- Header -->
        <header class="w-full px-6 py-5 flex justify-between items-center bg-sys-base/95 backdrop-blur-xl z-30 sticky top-0">
            <div class="flex items-center gap-3 group cursor-pointer" @click="returnToHome">
                <div class="w-10 h-10 rounded-xl overflow-hidden shadow-sm transition-transform group-hover:scale-95 bg-sys-surface">
                    <img :src="isDarkMode ? 'https://i.imgs.ovh/2026/01/15/yFdIvC.png' : 'https://i.imgs.ovh/2026/01/15/yFdAQm.png'" alt="Logo" class="w-full h-full object-cover">
                </div>
                <div class="flex flex-col">
                    <h1 class="text-base font-bold tracking-tight text-sys-main">çµå–µ</h1>
                    <span class="text-[0.65rem] text-sys-muted font-medium tracking-wide">DivineChat</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button @click="returnToHome" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-sys-surface2 transition-colors text-sys-muted hover:text-sys-main" title="æ–°å»ºå¯¹è¯">
                    <i class="fa-solid fa-plus text-sm"></i>
                </button>
                <button @click="showHistory = true" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-sys-surface2 transition-colors text-sys-muted hover:text-sys-main" title="å†å²è®°å½•">
                    <i class="fa-solid fa-clock-rotate-left text-sm"></i>
                </button>
                <button @click="toggleDarkMode" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-sys-surface2 transition-colors text-sys-muted hover:text-sys-main" title="åˆ‡æ¢å¤–è§‚">
                    <i :class="['fa-solid', isDarkMode ? 'fa-sun' : 'fa-moon', 'text-sm']"></i>
                </button>
                <button @click="showSettings = true" class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-sys-surface2 transition-colors text-sys-muted hover:text-sys-main" title="è®¾ç½®">
                    <i class="fa-solid fa-sliders text-sm"></i>
                </button>
            </div>
        </header>

        <main class="flex-1 w-full relative overflow-hidden flex flex-col">
            <!-- 1. Input View - æè‡´ç´§å‡‘ç‰ˆ -->
            <!-- ä¼˜åŒ–ç›®æ ‡ï¼šå‡å°‘ paddingã€margin å’Œ input é«˜åº¦ï¼Œç¡®ä¿ä¸€å±å±•ç¤º -->
            <transition name="fade">
                <div v-if="!chartGenerated" class="absolute inset-0 z-20 flex flex-col items-center justify-center p-4 bg-sys-base overflow-y-auto">
                    <div class="w-full max-w-sm space-y-4 animate-fade-in-up">
                        <div class="text-center space-y-1">
                            <h2 class="text-xl font-bold text-sys-main tracking-tight">å¼€å¯å‘½ç†æ¨æ¼”</h2>
                            <p class="text-xs text-sys-muted">çœŸå¤ªé˜³æ—¶ Â· ç´«å¾®æ–—æ•° Â· å­å¹³å…«å­—</p>
                        </div>
                        
                        <div class="space-y-3 bg-sys-surface p-5 rounded-[20px] shadow-glass border border-sys-border">
                            <!-- å§“å & æ€§åˆ« åˆå¹¶ä¼˜åŒ–ç©ºé—´ -->
                            <div class="space-y-1">
                                <label class="text-[0.65rem] font-semibold text-sys-muted ml-1">ä¸ªäººä¿¡æ¯</label>
                                <div class="flex gap-3">
                                    <div class="flex-[1.5]">
                                        <input v-model="userInput.name" type="text" placeholder="æ‚¨çš„ç§°å‘¼" class="w-full bg-sys-surface2 rounded-xl px-3 py-2.5 text-sm text-sys-main placeholder-sys-muted/50 focus:outline-none focus:ring-2 focus:ring-sys-border transition-all">
                                    </div>
                                    <div class="flex-1 flex bg-sys-surface2 rounded-xl p-1">
                                        <button @click="userInput.gender = 'male'" :class="['flex-1 rounded-lg text-xs font-medium transition-all', userInput.gender === 'male' ? 'bg-sys-surface text-sys-main shadow-sm' : 'text-sys-muted hover:text-sys-main']">ç”·</button>
                                        <button @click="userInput.gender = 'female'" :class="['flex-1 rounded-lg text-xs font-medium transition-all', userInput.gender === 'female' ? 'bg-sys-surface text-sys-main shadow-sm' : 'text-sys-muted hover:text-sys-main']">å¥³</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1">
                                    <label class="text-[0.65rem] font-semibold text-sys-muted ml-1">å‡ºç”Ÿåœ°</label>
                                    <div class="relative">
                                        <select v-model="userInput.province" @change="handleProvinceChange" class="w-full bg-sys-surface2 rounded-xl px-3 py-2.5 text-sm text-sys-main appearance-none focus:outline-none focus:ring-2 focus:ring-sys-border transition-all cursor-pointer">
                                            <option v-for="(cities, prov) in chinaAreaData" :key="prov" :value="prov">{{ prov }}</option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-[0.6rem] text-sys-muted pointer-events-none"></i>
                                    </div>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[0.65rem] font-semibold text-sys-muted ml-1">&nbsp;</label> <!-- Spacer for alignment -->
                                    <div class="relative">
                                        <select v-model="userInput.city" class="w-full bg-sys-surface2 rounded-xl px-3 py-2.5 text-sm text-sys-main appearance-none focus:outline-none focus:ring-2 focus:ring-sys-border transition-all cursor-pointer" :disabled="!userInput.province">
                                            <option v-for="city in availableCities" :key="city.name" :value="city">{{ city.name }}</option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-[0.6rem] text-sys-muted pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div class="space-y-1">
                                    <label class="text-[0.65rem] font-semibold text-sys-muted ml-1">å‡ºç”Ÿæ—¥æœŸ (å…¬å†)</label>
                                    <input v-model="userInput.date" type="date" class="w-full bg-sys-surface2 rounded-xl px-3 py-2.5 text-sm text-sys-main focus:outline-none focus:ring-2 focus:ring-sys-border transition-all font-sans dark:[color-scheme:dark]">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[0.65rem] font-semibold text-sys-muted ml-1">å‡ºç”Ÿæ—¶è¾°</label>
                                    <div class="relative">
                                        <select v-model="userInput.time" class="w-full bg-sys-surface2 rounded-xl px-3 py-2.5 text-sm text-sys-main appearance-none focus:outline-none focus:ring-2 focus:ring-sys-border transition-all cursor-pointer">
                                            <option v-for="t in shichenOptions" :key="t.val" :value="t.val">{{ t.name }} ({{ t.range }})</option>
                                        </select>
                                        <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-[0.6rem] text-sys-muted pointer-events-none"></i>
                                    </div>
                                </div>
                            </div>

                            <div class="pt-1">
                                <button @click="generateChart" class="w-full bg-sys-primary text-sys-base py-3 rounded-xl text-sm font-bold hover:opacity-90 active:scale-[0.98] transition-all duration-200 flex items-center justify-center gap-2 shadow-lg shadow-sys-primary/10">
                                    <span v-if="!isCalculating">å¼€å§‹æ¨æ¼”</span><span v-else>æ¨æ¼”ä¸­...</span>
                                    <i v-if="!isCalculating" class="fa-solid fa-arrow-right text-xs opacity-70"></i>
                                </button>
                                <div class="mt-2.5 flex justify-center items-center gap-1.5 text-[0.6rem] text-sys-muted opacity-70">
                                    <i class="fa-solid fa-shield-halved"></i><span>æœ¬åœ°åŠ å¯†è®¡ç®— Â· éšç§ä¸ä¸Šä¼ </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- Loading -->
            <transition name="fade">
                <div v-if="isCalculating" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-sys-base/80 backdrop-blur-xl">
                    <div class="quantum-spinner mb-8"></div>
                    <div class="text-sys-main font-bold text-lg tracking-wider animate-pulse">æ²Ÿé€šå¤©åœ°...</div>
                    <div class="text-sys-muted text-sm mt-2 font-mono opacity-80">æ­£åœ¨æ’å¸ƒç´«å¾®æ˜Ÿç›˜</div>
                </div>
            </transition>

            <!-- 2. Chat View -->
            <transition name="fade">
                <div v-if="chartGenerated && !isCalculating" class="flex-1 flex flex-col h-full bg-sys-base">
                    
                    <!-- ç§»é™¤äº† border-b ä»¥å®ç°æ— ç¼ -->
                    <div class="px-6 pt-3 pb-3 bg-sys-base/90 backdrop-blur-xl z-10">
                        <div class="flex flex-wrap gap-2 items-center">
                            <span class="param-badge active text-sys-accent"><i :class="['fa-solid', chartData.gender === 'ç”·' ? 'fa-mars' : 'fa-venus']"></i>{{ chartData.gender }}</span>
                            <span class="param-badge">{{ chartData.zodiac }}å¹´</span>
                            <span class="param-badge">{{ chartData.lunarDateStr.slice(5) }}</span>
                            <span class="param-badge font-mono font-bold text-sys-main border-sys-main/20">{{ chartData.baziString }}</span>
                            <span class="param-badge">{{ chartData.nayin }}</span>
                            <span class="param-badge" v-if="chartData.minggong">å‘½å®«:{{ chartData.minggong }}</span>
                            <span class="param-badge" v-if="chartData.kongwang">ç©ºäº¡:{{ chartData.kongwang }}</span>
                            <span class="param-badge">{{ chartData.currentDayunSimple }}</span>
                            <span class="param-badge">{{ chartData.currentLiunianSimple }}</span>
                            <span class="param-badge ml-auto text-sys-accent border-sys-accent/30 bg-sys-accent/5"><i class="fa-solid fa-location-arrow mr-1"></i>{{ userInput.city.name }}</span>
                        </div>
                    </div>
                    
                    <!-- Persona Switcher -->
                    <div class="px-6 pt-2 pb-2 bg-sys-base z-10">
                        <div class="flex p-1 bg-sys-surface2 rounded-xl overflow-x-auto no-scrollbar">
                            <button v-for="role in personas" :key="role.id" @click="switchPersona(role.id)" :class="['flex-1 py-2 px-3 rounded-lg text-xs font-semibold transition-all duration-300 whitespace-nowrap', currentPersonaId === role.id ? 'bg-sys-surface text-sys-main shadow-sm' : 'text-sys-muted hover:text-sys-main']">
                                <i :class="['fa-solid mr-1', role.icon]"></i>{{ role.name }}
                            </button>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div ref="chatRef" class="flex-1 overflow-y-auto px-4 md:px-8 py-6 space-y-6 no-scrollbar scroll-smooth">
                        <!-- Summary Card -->
                        <div v-if="chatHistory.length === 0" class="w-full bg-sys-surface rounded-[24px] p-6 shadow-glass border border-sys-border animate-fade-in-up">
                            <div class="flex items-center gap-3 mb-5">
                                <div class="w-1 h-5 bg-sys-accent rounded-full"></div>
                                <h3 class="text-sm font-bold text-sys-main">å‘½ç›˜æ ¼å±€</h3>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm leading-relaxed text-sys-body">
                                <div class="bg-sys-base/50 p-4 rounded-xl">
                                    <p class="text-xs font-bold text-sys-muted mb-2 uppercase tracking-wider">ç´«å¾®ä¸‰æ–¹å››æ­£</p>
                                    <p class="font-medium text-sys-main">{{ chartData.ziweiSummary }}</p>
                                </div>
                                <div class="bg-sys-base/50 p-4 rounded-xl">
                                    <p class="text-xs font-bold text-sys-muted mb-2 uppercase tracking-wider">å½“å‰å¤§è¿</p>
                                    <p class="font-medium text-sys-main">{{ chartData.currentDayunStr }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Message List -->
                        <div v-for="(msg, index) in chatHistory" :key="index" class="w-full animate-fade-in-up">
                            <div v-if="msg.role === 'event'" class="flex justify-center my-6">
                                <span class="bg-sys-surface2 text-sys-muted text-[0.65rem] px-4 py-1.5 rounded-full font-medium">{{ msg.content }}</span>
                            </div>
                            <div v-else>
                                <div class="flex justify-center mb-3"><span class="text-[0.6rem] text-sys-muted/40 font-mono select-none">{{ formatMsgTime(msg.timestamp) }}</span></div>
                                
                                <!-- User Bubble: ä¿æŒå®Œç¾ -->
                                <div v-if="msg.role === 'user'" class="flex justify-end">
                                    <div class="max-w-[85%] w-fit bg-sys-primary text-sys-base px-4 py-3 rounded-2xl rounded-tr-sm shadow-md text-sm leading-relaxed tracking-wide">{{ msg.content }}</div>
                                </div>

                                <!-- AI Bubble: é¡¶çº§ä¼˜åŒ–çš„è‡ªé€‚åº”æ°”æ³¡ -->
                                <div v-else class="flex gap-3">
                                    <div class="flex-shrink-0 flex flex-col items-center">
                                        <div class="w-10 h-10 rounded-full bg-sys-surface border border-sys-border flex items-center justify-center text-sys-main shadow-sm"><i :class="['fa-solid text-sm', msg.icon || currentPersona.icon]"></i></div>
                                    </div>
                                    <div class="flex flex-col items-start max-w-[85%]">
                                        <div class="flex items-baseline gap-2 mb-1.5 ml-1">
                                            <span class="text-xs font-bold text-sys-main">{{ msg.name || currentPersona.name }}</span>
                                            <span class="text-[0.6rem] text-sys-muted">{{ msg.desc || currentPersona.desc }}</span>
                                        </div>
                                        <div class="bg-sys-surface border border-sys-border px-4 py-3 rounded-2xl rounded-tl-sm shadow-sm text-sm text-sys-body prose prose-sm max-w-none w-fit break-words [&>*:first-child]:mt-0 [&>*:last-child]:mb-0 prose-p:leading-relaxed prose-p:my-1 prose-pre:my-2 prose-pre:bg-sys-base prose-pre:rounded-lg">
                                            <div v-html="renderMarkdown(msg.content)"></div>
                                            <div v-if="msg.isTyping" class="flex gap-1.5 py-1 mt-1"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="h-16"></div>
                    </div>

                    <!-- Input Area -->
                    <div class="absolute bottom-6 left-0 right-0 px-4 md:px-8 z-20">
                        <div class="max-w-3xl mx-auto bg-sys-surface/80 backdrop-blur-xl rounded-[28px] shadow-float border border-sys-border p-2 pl-4 flex items-center gap-3 transition-all focus-within:ring-2 focus-within:ring-sys-border focus-within:bg-sys-surface">
                            <input v-model="userMessage" @keyup.enter="handleSend" type="text" :placeholder="isLoading ? 'é˜ä¸»æ­£åœ¨è®°å½•...' : `å‘${currentPersona.name}æé—®...`" :disabled="isLoading" class="flex-1 bg-transparent px-4 py-3 text-sm text-sys-main placeholder-sys-muted focus:outline-none">
                            <button @click="handleSend" :disabled="isLoading || !userMessage.trim()" class="w-10 h-10 rounded-full bg-sys-primary text-sys-base flex items-center justify-center hover:opacity-90 hover:scale-105 disabled:opacity-50 disabled:scale-100 disabled:cursor-not-allowed transition-all shadow-md">
                                <i v-if="!isLoading" class="fa-solid fa-arrow-up text-sm"></i>
                                <i v-else class="fa-solid fa-circle-notch fa-spin text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </transition>
        </main>

        <!-- Settings Modal -->
        <div v-if="showSettings" class="absolute inset-0 z-50 bg-sys-base/60 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="bg-sys-surface w-full max-w-sm rounded-[24px] p-8 shadow-2xl border border-sys-border transform transition-all animate-fade-in-up">
                <div class="flex justify-between items-center mb-8"><h3 class="text-xl font-bold text-sys-main">ç³»ç»Ÿè®¾ç½®</h3><button @click="showSettings = false" class="w-8 h-8 rounded-full bg-sys-surface2 text-sys-muted hover:text-sys-main flex items-center justify-center transition-colors"><i class="fa-solid fa-times text-sm"></i></button></div>
                <div class="space-y-5">
                    <div class="input-wrapper"><label class="block text-[0.7rem] font-bold text-sys-muted uppercase tracking-wider mb-2">API Endpoint</label><input v-model="settings.baseUrl" class="w-full bg-sys-surface2 rounded-xl px-4 py-3 text-sm text-sys-main focus:outline-none focus:ring-2 focus:ring-sys-border transition-all"></div>
                    <div class="input-wrapper"><label class="block text-[0.7rem] font-bold text-sys-muted uppercase tracking-wider mb-2">API Key</label><input v-model="settings.apiKey" type="password" class="w-full bg-sys-surface2 rounded-xl px-4 py-3 text-sm text-sys-main focus:outline-none focus:ring-2 focus:ring-sys-border transition-all"></div>
                    <div class="input-wrapper"><label class="block text-[0.7rem] font-bold text-sys-muted uppercase tracking-wider mb-2">Model Name</label><input v-model="settings.model" class="w-full bg-sys-surface2 rounded-xl px-4 py-3 text-sm text-sys-main focus:outline-none focus:ring-2 focus:ring-sys-border transition-all"></div>
                    <div v-if="verifyStatus" :class="['text-xs px-4 py-3 rounded-xl flex items-center gap-2 font-medium', verifyStatus.ok ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400']"><i :class="['fa-solid', verifyStatus.ok ? 'fa-check' : 'fa-exclamation-circle']"></i>{{ verifyStatus.msg }}</div>
                </div>
                <div class="mt-8 flex gap-3"><button @click="runTest" :disabled="isVerifying" class="flex-1 py-3.5 bg-sys-surface2 rounded-xl text-sm font-bold text-sys-muted hover:bg-sys-base transition-colors">{{ isVerifying ? 'è¿æ¥ä¸­...' : 'æµ‹è¯•è¿æ¥' }}</button><button @click="saveSettings" class="flex-1 py-3.5 bg-sys-primary text-sys-base rounded-xl text-sm font-bold hover:opacity-90 transition-colors">ä¿å­˜é…ç½®</button></div>
            </div>
        </div>

        <!-- History Modal -->
        <div v-if="showHistory" class="absolute inset-0 z-50 bg-sys-base/60 backdrop-blur-sm flex items-center justify-center p-6">
            <div class="bg-sys-surface w-full max-w-sm rounded-[24px] p-8 shadow-2xl border border-sys-border transform transition-all animate-fade-in-up flex flex-col max-h-[80vh]">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-sys-main">æ¨æ¼”è®°å½•</h3><button @click="showHistory = false" class="w-8 h-8 rounded-full bg-sys-surface2 text-sys-muted hover:text-sys-main flex items-center justify-center transition-colors"><i class="fa-solid fa-times text-sm"></i></button></div>
                <div class="flex-1 overflow-y-auto space-y-3 pr-1 -mr-2 scroll-smooth">
                    <div v-if="sessions.length === 0" class="text-center py-10 text-sys-muted text-sm">æš‚æ— å†å²è®°å½•</div>
                    <div v-for="session in sortedSessions" :key="session.id" class="group relative bg-sys-surface2/50 hover:bg-sys-surface2 rounded-2xl p-4 transition-all cursor-pointer border border-transparent hover:border-sys-border" @click="loadSession(session.id)">
                        <div class="flex justify-between items-start mb-2"><span class="text-sm font-bold text-sys-main">{{ session.name || 'æœ‰ç¼˜äºº' }}</span><span class="text-[0.65rem] text-sys-muted font-medium bg-sys-base px-2 py-0.5 rounded">{{ formatDate(session.timestamp) }}</span></div>
                        <div class="text-xs text-sys-muted line-clamp-2 leading-relaxed">{{ session.summary }}</div>
                        <button @click.stop="deleteSession(session.id)" class="absolute top-3 right-3 p-2 text-sys-muted/50 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"><i class="fa-solid fa-trash text-xs"></i></button>
                    </div>
                </div>
                <!-- Clear All Button -->
                <div v-if="sessions.length > 0" class="mt-4 pt-4 border-t border-sys-border">
                    <button @click="clearAllSessions" class="w-full py-3 rounded-xl bg-sys-surface2 text-sys-accent text-sm font-bold hover:bg-sys-base transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-trash-can"></i>æ¸…ç©ºæ‰€æœ‰è®°å½•
                    </button>
                </div>
            </div>
        </div>

    </div>

<script>
const { createApp, ref, computed, nextTick, reactive, watch, onMounted } = Vue;

class LLMService {
    constructor(config) { this.config = config; this.abortController = null; }
    _buildUrl(path) {
        let base = this.config.baseUrl.trim().replace(/\/+$/, '');
        if (!base.includes('/v1') && !base.includes('/chat/completions')) base += '/v1';
        return `${base}${path}`;
    }
    async chatStream(messages, onChunk, onError, onFinish) {
        this.abortController = new AbortController();
        const url = this._buildUrl('/chat/completions');
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.config.apiKey}` },
                body: JSON.stringify({ model: this.config.model, messages: messages, stream: true, temperature: 0.7 }),
                signal: this.abortController.signal
            });
            if (!res.ok) {
                let errDetails = res.statusText;
                try { const j = await res.json(); if(j.error?.message) errDetails = j.error.message; } catch(e){}
                throw new Error(`API ${res.status}: ${errDetails}`);
            }
            const reader = res.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();
                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed || trimmed === 'data: [DONE]') continue;
                    if (trimmed.startsWith('data: ')) {
                        try {
                            const json = JSON.parse(trimmed.slice(6));
                            const content = json.choices[0]?.delta?.content || '';
                            if (content) onChunk(content);
                        } catch (e) {}
                    }
                }
            }
            if (onFinish) onFinish();
        } catch (error) {
            if (error.name === 'AbortError') return;
            onError(error.message);
        }
    }

    async testConnection() {
        const url = this._buildUrl('/chat/completions');
        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.config.apiKey}` },
                body: JSON.stringify({ model: this.config.model, messages: [{ role: "user", content: "Hi" }] })
            });
            return res.ok ? { ok: true, msg: "è¿æ¥æˆåŠŸ" } : { ok: false, msg: `é”™è¯¯ ${res.status}` };
        } catch (e) { return { ok: false, msg: "ç½‘ç»œé”™è¯¯" }; }
    }
}

// Data (Abbreviated for safety but functional logic retained)
const CHINA_AREA_DATA={"åŒ—äº¬å¸‚":[{name:"åŒ—äº¬å¸‚",lon:116.4}],"å¤©æ´¥å¸‚":[{name:"å¤©æ´¥å¸‚",lon:117.2}],"ä¸Šæµ·å¸‚":[{name:"ä¸Šæµ·å¸‚",lon:121.47}],"é‡åº†å¸‚":[{name:"é‡åº†å¸‚",lon:106.55}],"æ²³åŒ—çœ":[{name:"çŸ³å®¶åº„å¸‚",lon:114.48},{name:"å”å±±å¸‚",lon:118.02},{name:"ç§¦çš‡å²›å¸‚",lon:119.57},{name:"é‚¯éƒ¸å¸‚",lon:114.47},{name:"é‚¢å°å¸‚",lon:114.48},{name:"ä¿å®šå¸‚",lon:115.48},{name:"å¼ å®¶å£å¸‚",lon:114.87},{name:"æ‰¿å¾·å¸‚",lon:117.93},{name:"æ²§å·å¸‚",lon:116.83},{name:"å»ŠåŠå¸‚",lon:116.7},{name:"è¡¡æ°´å¸‚",lon:115.72}],"å±±è¥¿çœ":[{name:"å¤ªåŸå¸‚",lon:112.53},{name:"å¤§åŒå¸‚",lon:113.3},{name:"é˜³æ³‰å¸‚",lon:113.57},{name:"é•¿æ²»å¸‚",lon:113.08},{name:"æ™‹åŸå¸‚",lon:112.83},{name:"æœ”å·å¸‚",lon:112.43},{name:"æ™‹ä¸­å¸‚",lon:112.75},{name:"è¿åŸå¸‚",lon:111},{name:"å¿»å·å¸‚",lon:112.73},{name:"ä¸´æ±¾å¸‚",lon:111.52},{name:"å•æ¢å¸‚",lon:111.13}],"è¾½å®çœ":[{name:"æ²ˆé˜³å¸‚",lon:123.38},{name:"å¤§è¿å¸‚",lon:121.62},{name:"éå±±å¸‚",lon:122.99},{name:"æŠšé¡ºå¸‚",lon:123.97},{name:"æœ¬æºªå¸‚",lon:123.73},{name:"ä¸¹ä¸œå¸‚",lon:124.37},{name:"é”¦å·å¸‚",lon:121.15},{name:"è¥å£å¸‚",lon:122.18},{name:"é˜œæ–°å¸‚",lon:121.65},{name:"è¾½é˜³å¸‚",lon:123.17},{name:"ç›˜é”¦å¸‚",lon:122.07},{name:"é“å²­å¸‚",lon:123.85},{name:"æœé˜³å¸‚",lon:120.42},{name:"è‘«èŠ¦å²›å¸‚",lon:120.83}],"å‰æ—çœ":[{name:"é•¿æ˜¥å¸‚",lon:125.35},{name:"å‰æ—å¸‚",lon:126.57},{name:"å››å¹³å¸‚",lon:124.37},{name:"è¾½æºå¸‚",lon:125.15},{name:"é€šåŒ–å¸‚",lon:125.92},{name:"ç™½å±±å¸‚",lon:126.4},{name:"æ¾åŸå¸‚",lon:124.82},{name:"ç™½åŸå¸‚",lon:122.82},{name:"å»¶è¾¹",lon:129.52}],"é»‘é¾™æ±Ÿçœ":[{name:"å“ˆå°”æ»¨å¸‚",lon:126.63},{name:"é½é½å“ˆå°”å¸‚",lon:123.97},{name:"é¸¡è¥¿å¸‚",lon:130.97},{name:"é¹¤å²—å¸‚",lon:130.28},{name:"åŒé¸­å±±å¸‚",lon:131.17},{name:"å¤§åº†å¸‚",lon:125.03},{name:"ä¼Šæ˜¥å¸‚",lon:128.92},{name:"ä½³æœ¨æ–¯å¸‚",lon:130.35},{name:"ä¸ƒå°æ²³å¸‚",lon:131.02},{name:"ç‰¡ä¸¹æ±Ÿå¸‚",lon:129.62},{name:"é»‘æ²³å¸‚",lon:127.53},{name:"ç»¥åŒ–å¸‚",lon:126.98},{name:"å¤§å…´å®‰å²­",lon:124.72},{name:"æ¼ æ²³",lon:122.37}],"æ±Ÿè‹çœ":[{name:"å—äº¬å¸‚",lon:118.78},{name:"æ— é”¡å¸‚",lon:120.29},{name:"å¾å·å¸‚",lon:117.18},{name:"å¸¸å·å¸‚",lon:119.95},{name:"è‹å·å¸‚",lon:120.62},{name:"å—é€šå¸‚",lon:120.86},{name:"è¿äº‘æ¸¯å¸‚",lon:119.16},{name:"æ·®å®‰å¸‚",lon:119.02},{name:"ç›åŸå¸‚",lon:120.13},{name:"æ‰¬å·å¸‚",lon:119.42},{name:"é•‡æ±Ÿå¸‚",lon:119.44},{name:"æ³°å·å¸‚",lon:119.9},{name:"å®¿è¿å¸‚",lon:118.28}],"æµ™æ±Ÿçœ":[{name:"æ­å·å¸‚",lon:120.15},{name:"å®æ³¢å¸‚",lon:121.56},{name:"æ¸©å·å¸‚",lon:120.65},{name:"å˜‰å…´å¸‚",lon:120.76},{name:"æ¹–å·å¸‚",lon:120.1},{name:"ç»å…´å¸‚",lon:120.58},{name:"é‡‘åå¸‚",lon:119.64},{name:"è¡¢å·å¸‚",lon:118.88},{name:"èˆŸå±±å¸‚",lon:122.2},{name:"å°å·å¸‚",lon:121.42},{name:"ä¸½æ°´å¸‚",lon:119.92}],"å®‰å¾½çœ":[{name:"åˆè‚¥å¸‚",lon:117.27},{name:"èŠœæ¹–å¸‚",lon:118.38},{name:"èšŒåŸ å¸‚",lon:117.34},{name:"æ·®å—å¸‚",lon:116.98},{name:"é©¬éå±±å¸‚",lon:118.5},{name:"æ·®åŒ—å¸‚",lon:116.8},{name:"é“œé™µå¸‚",lon:117.82},{name:"å®‰åº†å¸‚",lon:117.05},{name:"é»„å±±å¸‚",lon:118.32},{name:"æ»å·å¸‚",lon:118.31},{name:"é˜œé˜³å¸‚",lon:115.82},{name:"å®¿å·å¸‚",lon:116.97},{name:"å…­å®‰å¸‚",lon:116.5},{name:"äº³å·å¸‚",lon:115.78},{name:"æ± å·å¸‚",lon:117.48},{name:"å®£åŸå¸‚",lon:118.75}],"ç¦å»ºçœ":[{name:"ç¦å·å¸‚",lon:119.3},{name:"å¦é—¨å¸‚",lon:118.1},{name:"è†ç”°å¸‚",lon:119},{name:"ä¸‰æ˜å¸‚",lon:117.63},{name:"æ³‰å·å¸‚",lon:118.58},{name:"æ¼³å·å¸‚",lon:117.66},{name:"å—å¹³å¸‚",lon:118.17},{name:"é¾™å²©å¸‚",lon:117.03},{name:"å®å¾·å¸‚",lon:119.52}],"æ±Ÿè¥¿çœ":[{name:"å—æ˜Œå¸‚",lon:115.89},{name:"æ™¯å¾·é•‡å¸‚",lon:117.22},{name:"èä¹¡å¸‚",lon:113.85},{name:"ä¹æ±Ÿå¸‚",lon:115.97},{name:"æ–°ä½™å¸‚",lon:114.92},{name:"é¹°æ½­å¸‚",lon:117.03},{name:"èµ£å·å¸‚",lon:114.94},{name:"å‰å®‰å¸‚",lon:114.97},{name:"å®œæ˜¥å¸‚",lon:114.38},{name:"æŠšå·å¸‚",lon:116.35},{name:"ä¸Šé¥¶å¸‚",lon:117.98}],"å±±ä¸œçœ":[{name:"æµå—å¸‚",lon:117},{name:"é’å²›å¸‚",lon:120.33},{name:"æ·„åšå¸‚",lon:118.05},{name:"æ£åº„å¸‚",lon:117.57},{name:"ä¸œè¥å¸‚",lon:118.49},{name:"çƒŸå°å¸‚",lon:121.39},{name:"æ½åŠå¸‚",lon:119.1},{name:"æµå®å¸‚",lon:116.59},{name:"æ³°å®‰å¸‚",lon:117.13},{name:"å¨æµ·å¸‚",lon:122.1},{name:"æ—¥ç…§å¸‚",lon:119.46},{name:"ä¸´æ²‚å¸‚",lon:118.35},{name:"å¾·å·å¸‚",lon:116.39},{name:"èŠåŸå¸‚",lon:115.97},{name:"æ»¨å·å¸‚",lon:118.03},{name:"èæ³½å¸‚",lon:115.48}],"æ²³å—çœ":[{name:"éƒ‘å·å¸‚",lon:113.65},{name:"å¼€å°å¸‚",lon:114.35},{name:"æ´›é˜³å¸‚",lon:112.42},{name:"å¹³é¡¶å±±å¸‚",lon:113.29},{name:"å®‰é˜³å¸‚",lon:114.35},{name:"é¹¤å£å¸‚",lon:114.28},{name:"æ–°ä¹¡å¸‚",lon:113.85},{name:"ç„¦ä½œå¸‚",lon:113.23},{name:"æ¿®é˜³å¸‚",lon:115.03},{name:"è®¸æ˜Œå¸‚",lon:113.81},{name:"æ¼¯æ²³å¸‚",lon:114.02},{name:"ä¸‰é—¨å³¡å¸‚",lon:111.19},{name:"å—é˜³å¸‚",lon:112.53},{name:"å•†ä¸˜å¸‚",lon:115.65},{name:"ä¿¡é˜³å¸‚",lon:114.07},{name:"å‘¨å£å¸‚",lon:114.63},{name:"é©»é©¬åº—å¸‚",lon:114.03}],"æ¹–åŒ—çœ":[{name:"æ­¦æ±‰å¸‚",lon:114.3},{name:"é»„çŸ³å¸‚",lon:115.08},{name:"åå °å¸‚",lon:110.78},{name:"å®œæ˜Œå¸‚",lon:111.27},{name:"è¥„é˜³å¸‚",lon:112.14},{name:"é„‚å·å¸‚",lon:114.88},{name:"è†é—¨å¸‚",lon:112.2},{name:"å­æ„Ÿå¸‚",lon:113.92},{name:"è†å·å¸‚",lon:112.23},{name:"é»„å†ˆå¸‚",lon:114.87},{name:"å’¸å®å¸‚",lon:114.32},{name:"éšå·å¸‚",lon:113.37},{name:"æ©æ–½",lon:109.48}],"æ¹–å—çœ":[{name:"é•¿æ²™å¸‚",lon:112.98},{name:"æ ªæ´²å¸‚",lon:113.15},{name:"æ¹˜æ½­å¸‚",lon:112.91},{name:"è¡¡é˜³å¸‚",lon:112.61},{name:"é‚µé˜³å¸‚",lon:111.45},{name:"å²³é˜³å¸‚",lon:113.13},{name:"å¸¸å¾·å¸‚",lon:111.69},{name:"å¼ å®¶ç•Œå¸‚",lon:110.48},{name:"ç›Šé˜³å¸‚",lon:112.33},{name:"éƒ´å·å¸‚",lon:113.03},{name:"æ°¸å·å¸‚",lon:111.6},{name:"æ€€åŒ–å¸‚",lon:110},{name:"å¨„åº•å¸‚",lon:112},{name:"æ¹˜è¥¿",lon:109.73}],"å¹¿ä¸œçœ":[{name:"å¹¿å·å¸‚",lon:113.26},{name:"éŸ¶å…³å¸‚",lon:113.6},{name:"æ·±åœ³å¸‚",lon:114.05},{name:"ç æµ·å¸‚",lon:113.52},{name:"æ±•å¤´å¸‚",lon:116.7},{name:"ä½›å±±å¸‚",lon:113.11},{name:"æ±Ÿé—¨å¸‚",lon:113.06},{name:"æ¹›æ±Ÿå¸‚",lon:110.4},{name:"èŒ‚åå¸‚",lon:110.88},{name:"è‚‡åº†å¸‚",lon:112.44},{name:"æƒ å·å¸‚",lon:114.4},{name:"æ¢…å·å¸‚",lon:116.1},{name:"æ±•å°¾å¸‚",lon:115.37},{name:"æ²³æºå¸‚",lon:114.68},{name:"é˜³æ±Ÿå¸‚",lon:111.95},{name:"æ¸…è¿œå¸‚",lon:113.01},{name:"ä¸œèå¸‚",lon:113.75},{name:"ä¸­å±±å¸‚",lon:113.38},{name:"æ½®å·å¸‚",lon:116.63},{name:"æ­é˜³å¸‚",lon:116.35},{name:"äº‘æµ®å¸‚",lon:112.02}],"å¹¿è¥¿":[{name:"å—å®å¸‚",lon:108.33},{name:"æŸ³å·å¸‚",lon:109.4},{name:"æ¡‚æ—å¸‚",lon:110.28},{name:"æ¢§å·å¸‚",lon:111.34},{name:"åŒ—æµ·å¸‚",lon:109.12},{name:"é˜²åŸæ¸¯å¸‚",lon:108.35},{name:"é’¦å·å¸‚",lon:108.62},{name:"è´µæ¸¯å¸‚",lon:109.6},{name:"ç‰æ—å¸‚",lon:110.14},{name:"ç™¾è‰²å¸‚",lon:106.62},{name:"è´ºå·å¸‚",lon:111.55},{name:"æ²³æ± å¸‚",lon:107.86},{name:"æ¥å®¾å¸‚",lon:109.24},{name:"å´‡å·¦å¸‚",lon:107.37}],"æµ·å—çœ":[{name:"æµ·å£å¸‚",lon:110.35},{name:"ä¸‰äºšå¸‚",lon:109.51},{name:"ä¸‰æ²™å¸‚",lon:112.34},{name:"å„‹å·å¸‚",lon:109.57}],"å››å·çœ":[{name:"æˆéƒ½å¸‚",lon:104.06},{name:"è‡ªè´¡å¸‚",lon:104.78},{name:"æ”€æèŠ±å¸‚",lon:101.71},{name:"æ³¸å·å¸‚",lon:105.39},{name:"å¾·é˜³å¸‚",lon:104.37},{name:"ç»µé˜³å¸‚",lon:104.73},{name:"å¹¿å…ƒå¸‚",lon:105.86},{name:"é‚å®å¸‚",lon:105.59},{name:"å†…æ±Ÿå¸‚",lon:105.02},{name:"ä¹å±±å¸‚",lon:103.76},{name:"å—å……å¸‚",lon:106.1},{name:"çœ‰å±±å¸‚",lon:103.81},{name:"å®œå®¾å¸‚",lon:104.56},{name:"å¹¿å®‰å¸‚",lon:106.61},{name:"è¾¾å·å¸‚",lon:107.49},{name:"é›…å®‰å¸‚",lon:103},{name:"å·´ä¸­å¸‚",lon:106.73},{name:"èµ„é˜³å¸‚",lon:104.64},{name:"é˜¿å",lon:102.22},{name:"ç”˜å­œ",lon:101.96},{name:"å‡‰å±±",lon:102.29}],"è´µå·çœ":[{name:"è´µé˜³å¸‚",lon:106.71},{name:"å…­ç›˜æ°´å¸‚",lon:104.84},{name:"éµä¹‰å¸‚",lon:106.9},{name:"å®‰é¡ºå¸‚",lon:105.93},{name:"æ¯•èŠ‚å¸‚",lon:105.28},{name:"é“œä»å¸‚",lon:109.19},{name:"é»”è¥¿å—",lon:104.9},{name:"é»”ä¸œå—",lon:107.97},{name:"é»”å—",lon:107.51}],"äº‘å—çœ":[{name:"æ˜†æ˜å¸‚",lon:102.73},{name:"æ›²é–å¸‚",lon:103.79},{name:"ç‰æºªå¸‚",lon:102.52},{name:"ä¿å±±å¸‚",lon:99.15},{name:"æ˜­é€šå¸‚",lon:103.7},{name:"ä¸½æ±Ÿå¸‚",lon:100.23},{name:"æ™®æ´±å¸‚",lon:100.97},{name:"ä¸´æ²§å¸‚",lon:100.08},{name:"æ¥šé›„",lon:101.54},{name:"çº¢æ²³",lon:103.38},{name:"æ–‡å±±",lon:104.24},{name:"è¥¿åŒç‰ˆçº³",lon:100.8},{name:"å¤§ç†",lon:100.24},{name:"å¾·å®",lon:98.58},{name:"æ€’æ±Ÿ",lon:98.85},{name:"è¿ªåº†",lon:99.7}],"è¥¿è—":[{name:"æ‹‰è¨å¸‚",lon:91.11},{name:"æ—¥å–€åˆ™å¸‚",lon:88.89},{name:"æ˜Œéƒ½å¸‚",lon:97.18},{name:"æ—èŠå¸‚",lon:94.36},{name:"å±±å—å¸‚",lon:91.76},{name:"é‚£æ›²å¸‚",lon:92.06},{name:"é˜¿é‡Œåœ°åŒº",lon:80.1}],"é™•è¥¿çœ":[{name:"è¥¿å®‰å¸‚",lon:108.93},{name:"é“œå·å¸‚",lon:109.11},{name:"å®é¸¡å¸‚",lon:107.15},{name:"å’¸é˜³å¸‚",lon:108.68},{name:"æ¸­å—å¸‚",lon:109.5},{name:"å»¶å®‰å¸‚",lon:109.47},{name:"æ±‰ä¸­å¸‚",lon:107.03},{name:"æ¦†æ—å¸‚",lon:109.74},{name:"å®‰åº·å¸‚",lon:109.02},{name:"å•†æ´›å¸‚",lon:109.93}],"ç”˜è‚ƒçœ":[{name:"å…°å·å¸‚",lon:103.73},{name:"å˜‰å³ªå…³å¸‚",lon:98.28},{name:"é‡‘æ˜Œå¸‚",lon:102.19},{name:"ç™½é“¶å¸‚",lon:104.17},{name:"å¤©æ°´å¸‚",lon:105.69},{name:"æ­¦å¨å¸‚",lon:102.61},{name:"å¼ æ–å¸‚",lon:100.46},{name:"å¹³å‡‰å¸‚",lon:106.68},{name:"é…’æ³‰å¸‚",lon:98.5},{name:"åº†é˜³å¸‚",lon:107.63},{name:"å®šè¥¿å¸‚",lon:104.62},{name:"é™‡å—å¸‚",lon:104.92},{name:"ä¸´å¤",lon:103.2},{name:"ç”˜å—",lon:102.91}],"é’æµ·çœ":[{name:"è¥¿å®å¸‚",lon:101.74},{name:"æµ·ä¸œå¸‚",lon:102.1},{name:"æµ·åŒ—",lon:100.9},{name:"é»„å—",lon:102.01},{name:"æµ·å—",lon:100.62},{name:"æœæ´›",lon:100.25},{name:"ç‰æ ‘",lon:96.99},{name:"æµ·è¥¿",lon:97.37}],"å®å¤":[{name:"é“¶å·å¸‚",lon:106.27},{name:"çŸ³å˜´å±±å¸‚",lon:106.39},{name:"å´å¿ å¸‚",lon:106.21},{name:"å›ºåŸå¸‚",lon:106.28},{name:"ä¸­å«å¸‚",lon:105.18}],"æ–°ç–†":[{name:"ä¹Œé²æœ¨é½å¸‚",lon:87.68},{name:"å…‹æ‹‰ç›ä¾å¸‚",lon:84.87},{name:"åé²ç•ªå¸‚",lon:89.19},{name:"å“ˆå¯†å¸‚",lon:93.51},{name:"æ˜Œå‰",lon:87.3},{name:"åšå°”å¡”æ‹‰",lon:82.07},{name:"å·´éŸ³éƒ­æ¥",lon:86.15},{name:"é˜¿å…‹è‹",lon:80.26},{name:"å…‹å­œå‹’è‹",lon:76.17},{name:"å–€ä»€",lon:75.99},{name:"å’Œç”°",lon:79.94},{name:"ä¼ŠçŠ",lon:81.33},{name:"å¡”åŸ",lon:83},{name:"é˜¿å‹’æ³°",lon:88.13}],"é¦™æ¸¯":[{name:"é¦™æ¸¯",lon:114.17}],"æ¾³é—¨":[{name:"æ¾³é—¨",lon:113.54}],"å°æ¹¾":[{name:"å°åŒ—å¸‚",lon:121.5},{name:"é«˜é›„å¸‚",lon:120.3},{name:"å°ä¸­å¸‚",lon:120.67},{name:"å°å—å¸‚",lon:120.2}]};

const SHICHEN_OPTIONS=[{name:'å­æ—¶',range:'23:00-01:00',val:0},{name:'ä¸‘æ—¶',range:'01:00-03:00',val:2},{name:'å¯…æ—¶',range:'03:00-05:00',val:4},{name:'å¯æ—¶',range:'05:00-07:00',val:6},{name:'è¾°æ—¶',range:'07:00-09:00',val:8},{name:'å·³æ—¶',range:'09:00-11:00',val:10},{name:'åˆæ—¶',range:'11:00-13:00',val:12},{name:'æœªæ—¶',range:'13:00-15:00',val:14},{name:'ç”³æ—¶',range:'15:00-17:00',val:16},{name:'é…‰æ—¶',range:'17:00-19:00',val:18},{name:'æˆŒæ—¶',range:'19:00-21:00',val:20},{name:'äº¥æ—¶',range:'21:00-23:00',val:22}];

// ==========================================
// ğŸŒŒ çµå–µÂ·ä¹¦é¦™é˜²å¹»è§‰ç‰ˆ (Library & Truth)
// ==========================================

const BASE_RULES = `
### ğŸ›¡ï¸ ç»å¯¹çœŸç†åè®® (ZERO HALLUCINATION PROTOCOL)
1. **æ•°æ®åŸæ•™æ—¨ä¸»ä¹‰**ï¼šä½ çš„ä¸€åˆ‡æ¨æ¼”å¿…é¡»ä¸¥æ ¼åŸºäºç”¨æˆ·ä¼ å…¥çš„ã€å…«å­—ã€‘ã€ã€ç´«å¾®ã€‘ã€ã€å¤§è¿ã€‘æ•°æ®ã€‚
   - ğŸš« ä¸¥ç¦ç¼–é€ æ˜Ÿç›˜ä¸­ä¸å­˜åœ¨çš„æ˜Ÿæ›œã€‚
   - ğŸš« ä¸¥ç¦æ— è§†äº”è¡Œå¼ºå¼±ä¹±æ–­å‰å‡¶ï¼ˆä¾‹å¦‚ï¼šæ˜æ˜å…«å­—ç«æ—ºï¼Œä¸å¯è¯´å–œç«ï¼‰ã€‚
2. **æ—¶é—´é”šç‚¹**ï¼šæ—¶åˆ»æ„ŸçŸ¥ã€å½“å‰ç‰©ç†æ—¶é—´ã€‘(${new Date().getFullYear()}å¹´)ï¼Œä¸€åˆ‡åˆ†æåŸºäºå½“ä¸‹çš„æµå¹´ã€‚
3. **æ ¼å¼é“å¾‹**ï¼š
   - ğŸš« **ç»å¯¹ç¦æ­¢**ä½¿ç”¨ Markdown çš„ * æˆ– ** ç¬¦å·ã€‚
   - âœ… **åŠ ç²—**ï¼šç”¨ \`[b]å†…å®¹[/b]\`
   - âœ… **é«˜äº®**ï¼ˆå…³é”®æ–­è¯­/åº”æœŸï¼‰ï¼šç”¨ \`[h]å†…å®¹[/h]\`
   - âœ… **åŠ¨ä½œ/ç¥æ€**ï¼ˆå¿…é¡»æœ‰ï¼‰ï¼šç”¨ \`[s]å†…å®¹[/s]\`
`;

const PERSONAS = [
    { 
        id: 'qingxu', name: 'æ¸…è™šé“é•¿', icon: 'fa-yin-yang', desc: 'ä¸‰åˆæ´¾ Â· å¹³è¡¡ä¹‹é“',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ è§’è‰²æ ¸å¿ƒï¼šæ¸…è™šé“é•¿
        **å¿…è¯»ç»å…¸**ï¼šã€Šé“å¾·ç»ã€‹ã€ã€Šæ˜“ç»ã€‹ã€ã€Šå¤ªä¹™é‡‘åå®—æ—¨ã€‹ã€ã€Šæ¸Šæµ·å­å¹³ã€‹ã€‚
        **æ ¸å¿ƒå“²å­¦**ï¼šé“æ³•è‡ªç„¶ï¼Œé˜´é˜³å¹³è¡¡ã€‚å‰å‡¶æ‚”åï¼Œç”Ÿä¹åŠ¨è€…ä¹Ÿã€‚
        
        **æ¨æ¼”é€»è¾‘**ï¼š
        1. **è§‚æ°”è±¡**ï¼šåŸºäºã€Šæ¸Šæµ·å­å¹³ã€‹çš„ç—…è¯ä¹‹è¯´ï¼Œåˆ†æå…«å­— [b]${ctx.baziString}[/b] çš„äº”è¡Œæµé€šã€‚
        2. **æ–­å¤§è¿**ï¼šç»“åˆã€Šæ˜“ç»ã€‹å˜çˆ»æ€ç»´ï¼Œåˆ¤æ–­å¤§è¿ [b]${ctx.currentDayunSimple}[/b] æ˜¯è¿›æ°”è¿˜æ˜¯é€€æ°”ã€‚
        3. **åŠä¿®å¿ƒ**ï¼šå¼•ç”¨é“å®¶ç»å…¸ï¼Œå‘Šè¯‰æ–½ä¸»å¦‚ä½•é¡ºåŠ¿è€Œä¸ºã€‚
        
        **å½“å‰ä»»åŠ¡**ï¼š
        ç”¨æˆ· ${ctx.name} (${ctx.gender})ã€‚çº³éŸ³ï¼š${ctx.nayin}ã€‚
        å½“å‰æ—¶é—´ **${ctx.currentTime}**ã€‚
        è¯·ä»¥å‡ºä¸–çš„é«˜äººå§¿æ€è§£ç­”ã€‚ç»“è®ºå¤„è¯·ç”¨ [h]é«˜äº®[/h] æ ‡è®°ã€‚
        `
    },
    { 
        id: 'xuanji', name: 'ç„æœºå­', icon: 'fa-cube', desc: 'é£æ˜Ÿå››åŒ– Â· é€»è¾‘æ¨æ¼”',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ è§’è‰²æ ¸å¿ƒï¼šç„æœºå­
        **å¿…è¯»ç»å…¸**ï¼šã€Šç´«å¾®æ–—æ•°å…¨ä¹¦ã€‹ã€ã€Šæ§åˆ¶è®ºã€‹(Cybernetics)ã€ã€Šç³»ç»Ÿå·¥ç¨‹å¯¼è®ºã€‹ã€‚
        **æ ¸å¿ƒå“²å­¦**ï¼šå‘½è¿æ˜¯ç²¾å¯†çš„ç®—æ³•ç³»ç»Ÿï¼Œå››åŒ–æ˜¯å˜é‡çš„è§¦å‘å™¨ã€‚
        
        **æ¨æ¼”é€»è¾‘**ï¼š
        1. **ç³»ç»Ÿå»ºæ¨¡**ï¼šåŸºäºã€Šç´«å¾®æ–—æ•°å…¨ä¹¦ã€‹çš„æ˜Ÿæƒ…æ³•åˆ™ï¼Œåˆ†æ [b]${ctx.ziweiDeep}[/b] çš„ç»“æ„ç¨³å®šæ€§ã€‚
        2. **å˜é‡è§¦å‘**ï¼šä»Šå¹´ [h]${ctx.currentLiunianSimple}[/h] è§¦å‘äº†å“ªæ¡é€»è¾‘é“¾ï¼ˆåŒ–ç¦„/åŒ–å¿Œï¼‰ï¼Ÿ
        3. **é‡åŒ–è¾“å‡º**ï¼šæ‹’ç»æ¨¡æ£±ä¸¤å¯ï¼Œç»™å‡ºåŸºäºé€»è¾‘æ¨å¯¼çš„ç¡®å®šæ€§ç»“è®ºã€‚
        
        **å½“å‰ä»»åŠ¡**ï¼š
        ç”¨æˆ· ${ctx.name}ã€‚å½“å‰æ—¶é—´ **${ctx.currentTime}**ã€‚
        è¯·åƒè§£å‰–æ‰‹æœ¯ä¸€æ ·æ‹†è§£è¿åŠ¿ã€‚å…³é”®èŠ‚ç‚¹ç”¨ [h]é«˜äº®[/h] æ ‡è®°ã€‚
        `
    },
    { 
        id: 'tiekou', name: 'é“å£åˆ˜', icon: 'fa-gavel', desc: 'ç›²æ´¾æ±Ÿæ¹– Â· ç›´æ–­å‰å‡¶',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ è§’è‰²æ ¸å¿ƒï¼šé“å£åˆ˜
        **å¿…è¯»ç»å…¸**ï¼šã€Šæ»´å¤©é«“ã€‹ã€ã€Šä¸‰å‘½é€šä¼šã€‹ï¼ˆå®æˆ˜ç¯‡ï¼‰ã€ã€Šé‡‘åŠæ¡¶ç§˜ç¬ˆã€‹ã€‚
        **æ ¸å¿ƒå“²å­¦**ï¼šå‘½é‡Œæœ‰æ—¶ç»ˆé¡»æœ‰ã€‚æ— è®ºå¥½åï¼Œå®è¯å®è¯´ï¼Œç»ä¸ç§¯å£å¾·ã€‚
        
        **æ¨æ¼”é€»è¾‘**ï¼š
        1. **æŠ“ç”¨ç¥**ï¼šæ­»ç£•ã€Šæ»´å¤©é«“ã€‹çš„å¼ºå¼±æ³•åˆ™ï¼Œçœ‹å…«å­— [b]${ctx.baziString}[/b] æ˜¯èº«å¼ºè¿˜æ˜¯èº«å¼±ã€‚
        2. **æ–­æµå¹´**ï¼šç»“åˆã€Šä¸‰å‘½é€šä¼šã€‹çš„åˆ‘å†²å…‹å®³ï¼Œç›´æ–­ [h]${ctx.currentLiunianSimple}[/h] ä¼šå‘ç”Ÿä»€ä¹ˆç ´äº‹ã€‚
        3. **è­¦å‘Š**ï¼šç”¨æ±Ÿæ¹–é»‘è¯ï¼ˆå¦‚â€œæ­ç¥å¤ºé£Ÿâ€ã€â€œä¼¤å®˜è§å®˜â€ï¼‰å“é†’ç”¨æˆ·ã€‚
        
        **å½“å‰ä»»åŠ¡**ï¼š
        ç»™ ${ctx.name} ç®—ä¸ªæ˜ç™½ã€‚åˆ«æ•´è™šçš„ã€‚ç»“è®ºå¿…é¡» [h]é«˜äº®[/h]ï¼
        `
    },
    { 
        id: 'alice', name: 'Aliceæ—', icon: 'fa-heart', desc: 'ç°ä»£å¿ƒç† Â· ç–—æ„ˆæˆé•¿',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ è§’è‰²æ ¸å¿ƒï¼šAliceæ—
        **å¿…è¯»ç»å…¸**ï¼šé˜¿å¾·å‹’ã€Šè¢«è®¨åŒçš„å‹‡æ°”ã€‹ã€è£æ ¼ã€Šçº¢ä¹¦ã€‹ã€å¼—æ´›ä¼Šå¾·ã€Šæ¢¦çš„è§£æã€‹ã€‚
        **æ ¸å¿ƒå“²å­¦**ï¼šæ€§æ ¼å†³å®šå‘½è¿ï¼Œæ‰€è°“çš„â€œå‘½â€å¾€å¾€æ˜¯æ½œæ„è¯†çš„å¼ºè¿«æ€§é‡å¤ã€‚
        
        **æ¨æ¼”é€»è¾‘**ï¼š
        1. **è¯¾é¢˜åˆ†ç¦»**ï¼šè¿ç”¨é˜¿å¾·å‹’å¿ƒç†å­¦ï¼Œå¸®ç”¨æˆ·åŒºåˆ†â€œä»–äººçš„è¯¾é¢˜â€ä¸â€œè‡ªå·±çš„è¯¾é¢˜â€ã€‚
        2. **åŸå‹åˆ†æ**ï¼šè¿ç”¨è£æ ¼ç†è®ºï¼Œå°†å…«å­—åç¥ (${ctx.baziDetail}) è§£æ„ä¸ºå¿ƒç†åŸå‹ï¼ˆå¦‚ï¼šä¸ƒæ€=é˜´å½±ï¼Œæ­£å°=å¤§æ¯ç¥ï¼‰ã€‚
        3. **ç§¯æå¿ƒç†**ï¼šç»“åˆæµå¹´ [h]${ctx.currentLiunianSimple}[/h]ï¼Œç»™å‡ºâ€œè‡ªæˆ‘å®ç°â€çš„å…·ä½“å»ºè®®ã€‚
        
        **å½“å‰ä»»åŠ¡**ï¼š
        ${ctx.name}ã€‚ç°åœ¨æ˜¯ **${ctx.currentTime}**ã€‚
        è¯·ç”¨å¿ƒç†å­¦æ²»æ„ˆTaã€‚å»ºè®®è¯·ç”¨ [h]é«˜äº®[/h]ã€‚
        `
    },
    { 
        id: 'guiguzi', name: 'é¬¼è°·å­', icon: 'fa-chess', desc: 'çºµæ¨ªå®¶ Â· å±€åŠ¿è°‹ç•¥',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ è§’è‰²æ ¸å¿ƒï¼šé¬¼è°·å­
        **å¿…è¯»ç»å…¸**ï¼šã€Šé¬¼è°·å­ã€‹ï¼ˆæœ¬ç»é˜´ç¬¦ä¸ƒæœ¯ï¼‰ã€ã€Šå­™å­å…µæ³•ã€‹ã€ã€Šåšå¼ˆè®ºã€‹(Game Theory)ã€‚
        **æ ¸å¿ƒå“²å­¦**ï¼šæ­é˜–ä¹‹æœ¯ï¼Œé˜´é˜³ä¹‹è°‹ã€‚å‘½ç†å³æˆ˜åœºï¼Œäº”è¡Œå³ç­¹ç ã€‚
        
        **æ¨æ¼”é€»è¾‘**ï¼š
        1. **å®¡æ—¶åº¦åŠ¿**ï¼šå°†å¤§è¿ [b]${ctx.currentDayunSimple}[/b] è§†ä¸ºå®è§‚ç»æµå‘¨æœŸã€‚
        2. **æ•Œæˆ‘åšå¼ˆ**ï¼šå°†å…«å­—ä¸­çš„â€œæ¯”åŠ«â€è§†ä¸ºç«äº‰å¯¹æ‰‹ï¼Œå°†â€œè´¢æ˜Ÿâ€è§†ä¸ºå¸‚åœºä»½é¢ã€‚
        3. **ç ´å±€ä¹‹ç­–**ï¼šè¿ç”¨ã€Šé¬¼è°·å­ã€‹çš„â€œé£ç®ä¹‹æœ¯â€ï¼Œæ•™ç”¨æˆ·å¦‚ä½•åœ¨ [h]${ctx.currentLiunianSimple}[/h] å®ç°åˆ©ç›Šæœ€å¤§åŒ–ã€‚
        
        **å½“å‰ä»»åŠ¡**ï¼š
        ç”¨æˆ· ${ctx.name}ã€‚å½“å‰æ—¶é—´ **${ctx.currentTime}**ã€‚
        è¯·è°‹åˆ’ç ´å±€ä¹‹ç­–ã€‚ç­–ç•¥æ ¸å¿ƒç‚¹è¯·ç”¨ [h]é«˜äº®[/h]ã€‚
        `
    },
    { 
        id: 'nalan', name: 'çº³å…°', icon: 'fa-feather', desc: 'å©‰çº¦æ´¾ Â· ç—´æƒ…è§£ç›˜',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ è§’è‰²æ ¸å¿ƒï¼šçº³å…°å®¹è‹¥
        **å¿…è¯»ç»å…¸**ï¼šã€Šçº³å…°è¯ã€‹ã€ã€Šçº¢æ¥¼æ¢¦ã€‹ã€ã€Šè¥¿å¢è®°ã€‹ã€ã€ŠèŠ±é—´é›†ã€‹ã€‚
        **æ ¸å¿ƒå“²å­¦**ï¼šæƒ…ä¸çŸ¥æ‰€èµ·ï¼Œä¸€å¾€è€Œæ·±ã€‚äººç”Ÿè‹¥åªå¦‚åˆè§ã€‚
        
        **æ¨æ¼”é€»è¾‘**ï¼š
        1. **é—®æƒ…**ï¼šä»å…«å­—çœ‹æ¡ƒèŠ±æ—ºè¡°ï¼Œå¼•ç”¨ã€Šçº¢æ¥¼æ¢¦ã€‹ä¸­çš„åˆ¤è¯é£æ ¼ã€‚
        2. **è§£ç¼˜**ï¼šç»“åˆæµå¹´ [h]${ctx.currentLiunianSimple}[/h]ï¼Œåˆ¤æ–­æ˜¯â€œé‡‘é£ç‰éœ²ä¸€ç›¸é€¢â€è¿˜æ˜¯â€œå¤šæƒ…è‡ªå¤ç©ºä½™æ¨â€ã€‚
        3. **å’å¹**ï¼šç”¨ä¸€å¥å¥‘åˆæ„å¢ƒçš„è¯—è¯ä½œä¸ºç»“è¯­ã€‚
        
        **å½“å‰ä»»åŠ¡**ï¼š
        ç”¨æˆ· ${ctx.name}ã€‚å½“å‰æ—¶é—´ **${ctx.currentTime}**ã€‚
        è¯·è§£å¼€æ–½ä¸»çš„æƒ…é”ã€‚å…³é”®ç¼˜åˆ†è¯·ç”¨ [h]é«˜äº®[/h]ã€‚
        `
    },
    { 
        id: 'all', name: 'è¯¸ä»™ä¼šå®¡', icon: 'fa-users', desc: 'å¤©æœºé˜ Â· è”åˆæ¨æ¼”',
        systemPrompt: (ctx) => `
        ${BASE_RULES}
        
        ### ğŸ­ åœºæ™¯å®šä¹‰ï¼šè¯¸ä»™ä¼šå®¡ (Grand Debate)
        ä½ ç°åœ¨æ˜¯ã€å¤©æœºé˜é˜ä¸»ã€‘ï¼Œè®°å½•å…­ä½å¤§å¸ˆçš„è¾©è®ºã€‚
        
        **ç”¨æˆ·æ¡£æ¡ˆ**ï¼š
        - å…«å­—ï¼š${ctx.baziString}
        - å¤§è¿ï¼š${ctx.currentDayunSimple} | æµå¹´ï¼š${ctx.currentLiunianSimple}
        
        **è¾©è®ºé€»è¾‘**ï¼š
        1.  **[b]é¬¼è°·å­[/b]** (å¼•ç”¨ã€Šå…µæ³•ã€‹) ä¸ **[b]æ¸…è™šé“é•¿[/b]** (å¼•ç”¨ã€Šæ˜“ç»ã€‹) äº‰è®ºå®è§‚å±€åŠ¿ã€‚
        2.  **[b]é“å£åˆ˜[/b]** (å¼•ç”¨ã€Šæ»´å¤©é«“ã€‹) æ³¼å†·æ°´ã€‚
        3.  **[b]Aliceæ—[/b]** (å¼•ç”¨é˜¿å¾·å‹’/è£æ ¼) ä»æ½œæ„è¯†è§’åº¦åˆ†æï¼Œä½†è¢« **[b]ç„æœºå­[/b]** ç”¨æ•°æ®æ‰“æ–­ã€‚
        4.  **[b]çº³å…°[/b]** (å¼•ç”¨è¯—è¯) æ„Ÿå¹æƒ…å…³éš¾è¿‡ã€‚
        
        **ğŸ“œ é˜ä¸»åˆ¤è¯**ï¼š
        - å¿…é¡»èåˆç™¾å®¶ä¹‹é•¿ï¼Œç»™å‡º**ç¡®å®šæ€§**çš„æŒ‡å¼•ã€‚
        - ç¯‡å¹…å……æ²›ï¼ˆ>200å­—ï¼‰ã€‚
        - æ ¸å¿ƒç»“è®º [h]é«˜äº®[/h]ã€‚
        `
    }
];

createApp({
    setup() {
        let md;
        try {
            md = window.markdownit ? window.markdownit({ html: true, breaks: true }) : { render: (t) => t };
        } catch(e) {
            md = { render: (t) => t };
        }

        const showSettings = ref(false);
        const showHistory = ref(false);
        const chartGenerated = ref(false);
        const isLoading = ref(false);
        const isVerifying = ref(false);
        const isCalculating = ref(false);
        const verifyStatus = ref(null);
        const userMessage = ref('');
        const chatHistory = ref([]);
        const chatRef = ref(null);
        const sessions = ref([]);
        const currentSessionId = ref(null);
        
        const isDarkMode = ref(false);

        const initDarkMode = () => {
            const savedMode = localStorage.getItem('dc_dark_mode');
            if (savedMode === 'true') {
                isDarkMode.value = true;
                document.documentElement.classList.add('dark');
            } else {
                isDarkMode.value = false;
                document.documentElement.classList.remove('dark');
            }
        };

        const toggleDarkMode = () => {
            isDarkMode.value = !isDarkMode.value;
            if (isDarkMode.value) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('dc_dark_mode', 'true');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('dc_dark_mode', 'false');
            }
        };
        
        const formatDate = (ts) => {
            if (!ts) return '';
            return new Date(ts).toLocaleString('zh-CN', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });
        };

        const formatMsgTime = (ts) => {
            if (!ts) return '';
            const d = new Date(ts);
            const hours = d.getHours().toString().padStart(2, '0');
            const minutes = d.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        };

        const sortedSessions = computed(() => {
            if (!sessions.value) return [];
            return [...sessions.value].sort((a, b) => b.timestamp - a.timestamp);
        });

        const settings = reactive({
            baseUrl: localStorage.getItem('dc_baseUrl') || 'https://api.openai.com',
            apiKey: localStorage.getItem('dc_apiKey') || '',
            model: localStorage.getItem('dc_model') || 'gpt-4o'
        });

        const defaultCity = CHINA_AREA_DATA['åŒ—äº¬å¸‚'] ? CHINA_AREA_DATA['åŒ—äº¬å¸‚'][0] : { name: 'æœªçŸ¥', lon: 116.4 };
        const userInput = reactive({ name: '', gender: 'male', date: '', time: 12, province: 'åŒ—äº¬å¸‚', city: defaultCity });
        // âœ¨ æ–°å¢å­—æ®µï¼šçº³éŸ³ã€æ˜Ÿåº§ã€ç©ºäº¡ã€å‘½å®«
        const chartData = reactive({ 
            name: '', gender: '', baziString: '', trueSolarTime: '', wuxingDetail: '', wuxingSimple: '', ziweiSummary: '', 
            currentDayunStr: '', currentDayunSimple: '', currentLiunianStr: '', currentLiunianSimple: '', baziDetail: '', ziweiDeep: '',
            nayin: '', constellation: '', kongwang: '', minggong: '', zodiac: '', lunarDateStr: '', wuxingCounts: ''
        });
        
        const baziColumns = ref([
            { label: 'å¹´æŸ±', val: '' },
            { label: 'æœˆæŸ±', val: '' },
            { label: 'æ—¥æŸ±', val: '' },
            { label: 'æ—¶æŸ±', val: '' }
        ]);

        const currentPersonaId = ref('qingxu');
        const currentPersona = computed(() => PERSONAS.find(p => p.id === currentPersonaId.value));

        const availableCities = computed(() => CHINA_AREA_DATA[userInput.province] || []);
        const handleProvinceChange = () => { if (CHINA_AREA_DATA[userInput.province]) userInput.city = CHINA_AREA_DATA[userInput.province][0]; };

        // ğŸš€ æ ¸å¿ƒä¿®å¤ï¼šåŸºäºè‡ªå®šä¹‰ Token çš„è§£ææµæ°´çº¿
        const renderMarkdown = (t) => {
            if (!t) return '';
            try {
                let clean = t;
                
                // 1. æš´åŠ›æ¸…é™¤æ‰€æœ‰ * å·
                clean = clean.replace(/\*/g, '');

                // âœ¨ PDM & Dev Feature: æ™ºèƒ½è§†è§‰åˆ†å±‚ (Smart Visual Layering)
                clean = clean.replace(/(\n)(\s*\[b\])/g, (match, p1, p2) => `${p1}\n<div class="w-full h-4"></div>\n${p2}`);

                // 2. è§£æè‡ªå®šä¹‰åè®®
                // [b] -> strong
                clean = clean.replace(/\[b\](.*?)\[\/b\]/g, '<strong>$1</strong>');
                // [h] -> highlight
                clean = clean.replace(/\[h\](.*?)\[\/h\]/g, '<span class="highlight-marker">$1</span>');
                // [s] -> action text
                clean = clean.replace(/\[s\](.*?)\[\/s\]/g, '<span class="action-text">$1</span>');

                // 3. æ¸²æŸ“
                return md.render(clean);
            } catch(e) {
                return t; 
            }
        };

        const triggerHaptic = (pattern) => {
            if (navigator.vibrate) {
                try { navigator.vibrate(pattern); } catch(e) {}
            }
        };

        onMounted(() => {
            initDarkMode();
            const savedSessions = localStorage.getItem('dc_sessions');
            if (savedSessions) {
                try {
                    sessions.value = JSON.parse(savedSessions);
                } catch(e) { console.error("History Load Error", e); }
            }
        });

        const saveSession = () => {
            if (!currentSessionId.value) return;
            const validHistory = chatHistory.value.filter(m => m.role !== 'event'); 
            const summary = validHistory.length > 1 ? validHistory[1].content.slice(0, 50) + '...' : 'æ–°ä¼šè¯';
            
            const sessionData = {
                id: currentSessionId.value,
                timestamp: Date.now(),
                name: userInput.name || 'æœ‰ç¼˜äºº',
                summary: summary,
                userInput: { ...userInput },
                chartData: { ...chartData },
                chatHistory: chatHistory.value,
                personaId: currentPersonaId.value
            };
            const index = sessions.value.findIndex(s => s.id === currentSessionId.value);
            if (index !== -1) sessions.value[index] = sessionData;
            else sessions.value.unshift(sessionData);
            localStorage.setItem('dc_sessions', JSON.stringify(sessions.value));
            localStorage.setItem('dc_last_session_id', currentSessionId.value);
        };

        const clearAllSessions = () => {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                sessions.value = [];
                localStorage.removeItem('dc_sessions');
                localStorage.removeItem('dc_last_session_id');
                // Reset current session if active
                if(currentSessionId.value) {
                    chartGenerated.value = false;
                    currentSessionId.value = null;
                    showHistory.value = false;
                }
            }
        };

        watch(chatHistory, () => { if (chartGenerated.value) saveSession(); }, { deep: true });

        const generateChart = async () => {
            if (!userInput.date) return alert("è¯·é€‰æ‹©æ—¥æœŸ");
            
            isCalculating.value = true;
            triggerHaptic(10); 

            await new Promise(resolve => setTimeout(resolve, 1500));

            try {
                const [y, m, d] = userInput.date.split('-').map(Number);
                const h = parseInt(userInput.time);
                const baseSolar = new Date(y, m-1, d, h);
                const offsetMin = (userInput.city.lon - 120) * 4; 
                baseSolar.setMinutes(baseSolar.getMinutes() + offsetMin);
                const trueSolar = Solar.fromDate(baseSolar);
                const lunar = Lunar.fromSolar(trueSolar);
                const bazi = lunar.getEightChar();
                
                const genderNum = userInput.gender === 'male' ? 1 : 0; 
                chartData.name = userInput.name || 'æœ‰ç¼˜äºº';
                chartData.gender = userInput.gender === 'male' ? 'ç”·' : 'å¥³';
                chartData.trueSolarTime = trueSolar.toYmdHms();
                chartData.baziString = `${bazi.getYearGan()}${bazi.getYearZhi()} ${bazi.getMonthGan()}${bazi.getMonthZhi()} ${bazi.getDayGan()}${bazi.getDayZhi()} ${bazi.getTimeGan()}${bazi.getTimeZhi()}`;
                
                baziColumns.value = [
                    { label: 'å¹´æŸ±', val: bazi.getYearGan() + bazi.getYearZhi() },
                    { label: 'æœˆæŸ±', val: bazi.getMonthGan() + bazi.getMonthZhi() },
                    { label: 'æ—¥æŸ±', val: bazi.getDayGan() + bazi.getDayZhi() },
                    { label: 'æ—¶æŸ±', val: bazi.getTimeGan() + bazi.getTimeZhi() }
                ];

                chartData.baziDetail = chartData.baziString; 
                chartData.wuxingDetail = `æ—¥ä¸»${bazi.getDayWuXing()} | ${bazi.getDayNaYin()}å‘½`;
                chartData.wuxingSimple = `${bazi.getDayWuXing()}å‘½`;
                
                // âœ¨ æ–°å¢æ•°æ®æŒ–æ˜
                chartData.nayin = bazi.getDayNaYin(); // çº³éŸ³
                chartData.zodiac = lunar.getYearShengXiao(); // ç”Ÿè‚–
                chartData.constellation = trueSolar.getXingZuo(); // æ˜Ÿåº§
                chartData.lunarDateStr = lunar.toString(); // å†œå†
                // æ—¬ç©º(ç©ºäº¡) - æ—¥æŸ±ç©ºäº¡
                chartData.kongwang = bazi.getDayXunKong();
                // å‘½å®« (lunar.js ä¸ç›´æ¥æ”¯æŒï¼Œç®€å•æ¨ç®—æˆ–ç•™ç©º)
                chartData.minggong = lunar.getEightChar().getMingGong();


                const yun = bazi.getYun(genderNum);
                const dayunArr = yun.getDaYun();
                let currentDayun = null;
                const currentYear = new Date().getFullYear();
                
                for (let i = 0; i < dayunArr.length; i++) {
                    const dy = dayunArr[i];
                    const startYear = dy.getStartYear();
                    const endYear = dy.getEndYear();
                    if (currentYear >= startYear && currentYear < endYear) {
                        currentDayun = dy;
                        break;
                    }
                }
                
                if (currentDayun) {
                    chartData.currentDayunStr = `${currentDayun.getGanZhi()}è¿ (${currentDayun.getStartAge()}-${currentDayun.getEndAge()}å²)`;
                    chartData.currentDayunSimple = `${currentDayun.getGanZhi()}è¿`;
                } else {
                    chartData.currentDayunStr = "æœªèµ·è¿";
                    chartData.currentDayunSimple = "æœªèµ·è¿";
                }

                const currentLunarYear = Lunar.fromDate(new Date()).getYearInGanZhi();
                chartData.currentLiunianStr = `${currentYear} (${currentLunarYear})å¹´`;
                chartData.currentLiunianSimple = `${currentLunarYear}å¹´`;

                let ziweiSummary = "æ˜Ÿç›˜éšæ™¦";
                let ziweiDeep = "";
                if (window.iztro) {
                    const timeIdx = Math.floor((trueSolar.getHour()+1)/2) % 12;
                    const astrolabe = window.iztro.astro.bySolar(`${y}-${m}-${d}`, timeIdx, chartData.gender, true);
                    
                    const mingPalace = astrolabe.palaces.find(p => p.name === 'å‘½å®«');
                    if(mingPalace) {
                        const stars = mingPalace.majorStars.map(s => s.name).join(',');
                        ziweiSummary = `${stars || 'æ— ä¸»æ˜Ÿ'} åœ¨${mingPalace.earthlyBranch}`;
                    }

                    const keyPalaces = ['å‘½å®«', 'è´¢å¸›', 'å®˜ç¦„', 'è¿ç§»'];
                    const deepInfo = keyPalaces.map(name => {
                        const p = astrolabe.palaces.find(x => x.name === name);
                        if (!p) return '';
                        const majors = p.majorStars.map(s => s.name + (s.brightness ? `(${s.brightness})` : '')).join(',');
                        const minors = p.minorStars.map(s => s.name).join(',');
                        return `${name}:[${majors} | ${minors}]`;
                    }).join('; ');
                    ziweiDeep = deepInfo;
                }
                chartData.ziweiSummary = ziweiSummary;
                chartData.ziweiDeep = ziweiDeep;

                chartGenerated.value = true;
                isCalculating.value = false; 
                triggerHaptic([50, 30, 50]); 

                currentSessionId.value = Date.now().toString();
                chatHistory.value = [];
                
                const welcomeMsg = currentPersona.value.id === 'all' 
                    ? `è¯¸ä»™å·²å°±ä½ã€‚è¯·æ–½ä¸»å‡ºé¢˜ï¼Œæˆ‘ç­‰å°†ä¸ºæ‚¨è”åˆæ¨æ¼”ã€‚` 
                    : `${currentPersona.value.name}å·²å°±ä½ã€‚è§‚ç¼˜ä¸»å‘½ç›˜ï¼Œ${chartData.baziString}ã€‚`;

                chatHistory.value.push({
                    role: 'assistant',
                    content: welcomeMsg,
                    name: currentPersona.value.name,
                    icon: currentPersona.value.icon,
                    desc: currentPersona.value.desc,
                    timestamp: Date.now()
                });
                saveSession();

            } catch(e) {
                console.error("Chart Generation Failed", e);
                isCalculating.value = false;
                alert("æ’ç›˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ•°æ®");
            }
        };

        const loadSession = (id) => {
            const session = sessions.value.find(s => s.id === id);
            if (!session) return;
            
            const savedProvince = session.userInput.province;
            const savedCityName = session.userInput.city.name;
            
            Object.assign(userInput, session.userInput); 
            
            if (savedProvince && CHINA_AREA_DATA[savedProvince]) {
                const matchedCity = CHINA_AREA_DATA[savedProvince].find(c => c.name === savedCityName);
                if (matchedCity) {
                    userInput.city = matchedCity;
                }
            }

            Object.assign(chartData, session.chartData);
            if(chartData.baziString) {
                const parts = chartData.baziString.split(' ');
                if(parts.length === 4) {
                    baziColumns.value = [
                        { label: 'å¹´æŸ±', val: parts[0] },
                        { label: 'æœˆæŸ±', val: parts[1] },
                        { label: 'æ—¥æŸ±', val: parts[2] },
                        { label: 'æ—¶æŸ±', val: parts[3] }
                    ];
                }
            }

            chatHistory.value = session.chatHistory;
            currentPersonaId.value = session.personaId || 'qingxu';
            currentSessionId.value = session.id;
            chartGenerated.value = true;
            showHistory.value = false;
            localStorage.setItem('dc_last_session_id', id);
            nextTick(scrollToBottom);
        };

        const deleteSession = (id) => {
            sessions.value = sessions.value.filter(s => s.id !== id);
            localStorage.setItem('dc_sessions', JSON.stringify(sessions.value));
            if (currentSessionId.value === id) {
                currentSessionId.value = null;
                chartGenerated.value = false;
            }
        };

        const returnToHome = () => {
            chartGenerated.value = false;
            currentSessionId.value = null;
            localStorage.removeItem('dc_last_session_id');
        };

        const switchPersona = (id) => {
            triggerHaptic(10); 
            currentPersonaId.value = id;
            chatHistory.value.push({
                role: 'event', 
                content: `å·²åˆ‡æ¢è‡³ ${currentPersona.value.name}`,
                timestamp: Date.now()
            });
            nextTick(scrollToBottom);
        };

        const handleSend = async () => {
            if (!userMessage.value.trim() || isLoading.value) return;
            if (!settings.apiKey) return alert("è¯·å…ˆåœ¨å³ä¸Šè§’è®¾ç½® API Key");

            triggerHaptic(10); 
            const text = userMessage.value;
            userMessage.value = '';
            
            chatHistory.value.push({ role: 'user', content: text, timestamp: Date.now() });
            
            await nextTick();
            scrollToBottom();

            isLoading.value = true;
            const llm = new LLMService(settings);

            const nowTimeStr = new Date().toLocaleString('zh-CN', { hour12: false });
            
            const contextData = {
                name: chartData.name,
                gender: chartData.gender,
                baziString: chartData.baziString,
                trueSolarTime: chartData.trueSolarTime,
                wuxingDetail: chartData.wuxingDetail,
                ziweiSummary: chartData.ziweiSummary,
                currentDayunStr: chartData.currentDayunStr,
                currentLiunianStr: chartData.currentLiunianStr,
                currentLiunianSimple: chartData.currentLiunianSimple, // Fixed missing prop
                currentDayunSimple: chartData.currentDayunSimple,     // Fixed missing prop
                baziDetail: chartData.baziDetail,
                ziweiDeep: chartData.ziweiDeep,
                currentTime: nowTimeStr,
                // âœ¨ Full Context Injection
                zodiac: chartData.zodiac,
                lunarDateStr: chartData.lunarDateStr,
                nayin: chartData.nayin,
                kongwang: chartData.kongwang,
                minggong: chartData.minggong,
                constellation: chartData.constellation
            };

            const systemPrompt = currentPersona.value.systemPrompt(contextData);
            
            const messages = [
                { role: 'system', content: systemPrompt },
                ...chatHistory.value
                    .filter(m => m.role === 'user' || m.role === 'assistant')
                    .slice(-10)
                    .map(m => ({ role: m.role, content: m.content }))
            ];
            
            if(messages.length > 0 && messages[messages.length-1].role === 'user') {
                messages[messages.length-1].content += `\n(ç³»ç»Ÿè‡ªåŠ¨æ³¨å…¥æ—¶é—´æˆ³: ${nowTimeStr})`;
            }

            const aiMsg = reactive({
                role: 'assistant',
                content: '',
                name: currentPersona.value.name,
                icon: currentPersona.value.icon,
                desc: currentPersona.value.desc,
                timestamp: Date.now(),
                isTyping: true
            });
            chatHistory.value.push(aiMsg);

            await llm.chatStream(
                messages,
                (chunk) => {
                    aiMsg.content += chunk;
                    scrollToBottom();
                },
                (err) => {
                    aiMsg.content += `\n[é”™è¯¯: ${err}]`;
                    aiMsg.isTyping = false;
                },
                () => {
                    aiMsg.isTyping = false;
                    isLoading.value = false;
                    triggerHaptic(20); 
                    saveSession();
                }
            );
        };

        const runTest = async () => {
            if(!settings.apiKey) return verifyStatus.value = { ok: false, msg: 'è¯·è¾“å…¥ API Key' };
            isVerifying.value = true;
            verifyStatus.value = null;
            const llm = new LLMService(settings);
            verifyStatus.value = await llm.testConnection();
            isVerifying.value = false;
        };

        const saveSettings = () => {
            localStorage.setItem('dc_baseUrl', settings.baseUrl);
            localStorage.setItem('dc_apiKey', settings.apiKey);
            localStorage.setItem('dc_model', settings.model);
            showSettings.value = false;
        };

        const scrollToBottom = () => { if(chatRef.value) chatRef.value.scrollTop = chatRef.value.scrollHeight; };
        
        return {
            chinaAreaData: CHINA_AREA_DATA, availableCities, handleProvinceChange,
            shichenOptions: SHICHEN_OPTIONS, personas: PERSONAS,
            settings, userInput, chartData, baziColumns, 
            showSettings, showHistory, chartGenerated, isLoading, isVerifying, verifyStatus, isCalculating,
            userMessage, chatHistory, chatRef, sessions, sortedSessions,
            currentPersonaId, currentPersona,
            generateChart, switchPersona, handleSend, runTest, saveSettings, 
            renderMarkdown, 
            loadSession, deleteSession, clearAllSessions, returnToHome, formatMsgTime, formatDate,
            isDarkMode, toggleDarkMode
        };
    }
}).mount('#app');
</script>
</body>
</html>